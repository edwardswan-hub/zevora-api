<!DOCTYPE html>
<html lang="zh-CN" class="dark scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>JULIAN. / Omnia</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,800&family=JetBrains+Mono:wght@400&display=swap');
    body { background: #050505; color: #f8f8f8; font-family: sans-serif; }
    .noise { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 9999; opacity: 0.04; background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E"); }
    .font-serif { font-family: 'Playfair Display', serif; }
    .font-mono { font-family: 'JetBrains Mono', monospace; }
    .prose { color: #d1d5db; line-height: 1.6; }
    .prose code { background: #1a1a1a; padding: 0.1rem 0.3rem; border-radius: 4px; font-family: 'JetBrains Mono'; }
  </style>
</head>
<body class="selection:bg-white selection:text-black">
  <div class="noise"></div>

  <header class="fixed top-0 w-full z-40 bg-[#050505]/80 backdrop-blur-md pt-6 pb-6 px-8 flex justify-between items-start border-b border-[#111]">
    <div class="text-[10px] font-mono text-gray-500 uppercase tracking-widest">
      <span id="liveTime">00:00:00</span> <br>
      <span id="sysStats">SYS: STANDBY</span>
    </div>
    <h1 class="font-serif text-2xl font-bold tracking-tighter">JULIAN.</h1>
    <button onclick="toggleAuth()" id="authBtn" class="text-[10px] font-mono text-white hover:underline uppercase tracking-widest">[ AUTH ]</button>
  </header>

  <main class="pt-32 pb-32 px-6 max-w-5xl mx-auto flex flex-col gap-24">
    <section>
      <h2 class="font-serif text-[10vw] md:text-[6vw] leading-none font-extrabold tracking-tighter mb-8">
        Chaos,<br><span class="text-gray-600 italic">Synthesized.</span>
      </h2>
      <p class="text-gray-400 font-light max-w-xl text-lg">In Omnia Paratus. 正在监控服务器频率与灵魂波动。</p>
    </section>

    <section id="adminPanel" class="hidden border-t border-[#222] pt-12">
      <h3 class="font-mono text-[10px] uppercase text-gray-500 tracking-[0.4em] mb-12">Mission Control / Dashboard</h3>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-12 font-mono">
        <div class="border border-[#222] p-6 bg-[#0a0a0a]">
          <p class="text-[10px] text-gray-600 mb-2">CPU LOAD</p>
          <p id="dash-cpu" class="text-3xl text-white">--%</p>
        </div>
        <div class="border border-[#222] p-6 bg-[#0a0a0a]">
          <p class="text-[10px] text-gray-600 mb-2">RAM LOAD</p>
          <p id="dash-ram" class="text-3xl text-white">--%</p>
        </div>
        <div class="md:col-span-2 border border-[#222] p-6 bg-[#0a0a0a]">
          <p class="text-[10px] text-gray-600 mb-2">DOCKER PROCESSES</p>
          <pre id="dash-docker" class="text-[10px] text-gray-400 leading-tight"></pre>
        </div>
      </div>

      <div class="border border-[#222] bg-[#0a0a0a]">
        <div class="flex justify-between items-center px-4 py-2 bg-[#111] border-b border-[#222]">
          <span class="text-[10px] font-mono text-gray-500 uppercase">File Editor: main.py</span>
          <button onclick="saveCode()" class="bg-white text-black text-[10px] px-4 py-1 font-bold tracking-widest hover:bg-gray-200">COMMIT & RESTART</button>
        </div>
        <textarea id="editor" class="w-full h-96 bg-transparent p-6 font-mono text-xs text-gray-300 outline-none resize-none leading-relaxed" spellcheck="false"></textarea>
      </div>
    </section>

    <section class="flex-1">
      <div id="postForm" class="hidden mb-12 space-y-4">
        <textarea id="msgInput" class="w-full bg-transparent border-b border-[#222] py-4 text-xl font-serif text-white outline-none focus:border-white transition-colors" placeholder="Type a fragment..."></textarea>
        <button onclick="sendMsg()" class="text-[10px] uppercase bg-white text-black px-6 py-2 font-bold tracking-widest">Submit</button>
      </div>
      <div id="postList" class="space-y-12"></div>
    </section>
  </main>

  <div id="authModal" class="fixed inset-0 bg-[#050505]/95 z-50 hidden flex items-center justify-center">
    <div class="max-w-xs w-full px-8 text-center">
      <h3 class="font-serif text-2xl mb-12">Identify, Sir.</h3>
      <input id="user" type="text" placeholder="IDENTITY" class="w-full bg-transparent border-b border-[#222] py-3 mb-6 outline-none text-center font-mono text-sm">
      <input id="pass" type="password" placeholder="PASSPHRASE" class="w-full bg-transparent border-b border-[#222] py-3 mb-12 outline-none text-center font-mono text-sm">
      <button onclick="login()" class="w-full bg-white text-black py-3 font-bold text-xs tracking-widest">VERIFY</button>
      <button onclick="toggleAuth()" class="block mt-6 mx-auto text-[10px] text-gray-600 tracking-widest uppercase">Abort</button>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    marked.setOptions({ gfm: true, breaks: true });

    async function loadMessages() {
      const res = await fetch('/api/messages');
      const data = await res.json();
      $('postList').innerHTML = data.items.map(i => `
        <article class="border-b border-[#111] pb-8">
          <div class="text-[9px] font-mono text-gray-600 mb-4 uppercase tracking-[0.3em]">${i.id} / ARCHIVE_DATA</div>
          <div class="prose">${DOMPurify.sanitize(marked.parse(i.content))}</div>
        </article>
      `).join('');
    }

    async function login() {
      const fd = new FormData();
      fd.append('username', $('user').value);
      fd.append('password', $('pass').value);
      const res = await fetch('/api/token', { method: 'POST', body: fd });
      const data = await res.json();
      if(data.access_token) {
        localStorage.setItem('token', data.access_token);
        location.reload();
      } else { alert('DENIED'); }
    }

    function toggleAuth() { $('authModal').classList.toggle('hidden'); }

    async function sendMsg() {
      const content = $('msgInput').value;
      const token = localStorage.getItem('token');
      await fetch(`/api/messages?content=${encodeURIComponent(content)}`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      $('msgInput').value = '';
      loadMessages();
    }

    // --- 控制中心逻辑 ---
    async function initAdmin() {
      const token = localStorage.getItem('token');
      if(!token) return;

      $('adminPanel').classList.remove('hidden');
      $('postForm').classList.remove('hidden');
      $('authBtn').innerText = "[ ACCESS GRANTED ]";

      // 1. 系统状态轮询
      setInterval(async () => {
        const res = await fetch('/api/sys/stats', { headers: { 'Authorization': `Bearer ${token}` } });
        const s = await res.json();
        $('dash-cpu').innerText = s.cpu + '%';
        $('dash-ram').innerText = s.ram + '%';
        $('dash-docker').innerText = s.docker;
        $('sysStats').innerText = `CPU ${s.cpu}% | RAM ${s.ram}%`;
      }, 5000);

      // 2. 加载代码
      const codeRes = await fetch('/api/editor/read?filename=main.py', { headers: { 'Authorization': `Bearer ${token}` } });
      const codeData = await codeRes.json();
      $('editor').value = codeData.content;
    }

    async function saveCode() {
      const token = localStorage.getItem('token');
      const content = $('editor').value;
      const res = await fetch('/api/editor/save', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename: 'main.py', content: content })
      });
      if(res.ok) {
        alert("Sir, Code committed. Server will restart in 60s.");
      }
    }

    function updateClock() {
      $('liveTime').innerText = new Date().toLocaleTimeString("en-US", { hour12: false, timeZone: "Asia/Shanghai" }) + " CST";
    }
    setInterval(updateClock, 1000);

    initAdmin();
    loadMessages();
  </script>
</body>
</html>
